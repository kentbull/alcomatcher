name: Deploy Web To DO

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on alcobot
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: alcomatcher.com
          username: root
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail
            TMP_ENV="/tmp/alcomatcher.env.backup"
            if [ -f /opt/alcomatcher/.env ]; then
              cp /opt/alcomatcher/.env "$TMP_ENV"
            fi
            rm -rf /opt/alcomatcher
            git clone --branch master --single-branch https://github.com/kentbull/alcomatcher.git /opt/alcomatcher
            cd /opt/alcomatcher
            if [ -f "$TMP_ENV" ]; then
              mv "$TMP_ENV" .env
            else
              cp .env.example .env
            fi
            docker compose down --remove-orphans || true
            docker compose up -d --build --remove-orphans
            for i in $(seq 1 20); do
              if curl -fsS http://127.0.0.1:3000/health >/dev/null; then
                break
              fi
              sleep 2
            done
            curl -fsS http://127.0.0.1:3000/health

      - name: Verify public health
        run: curl -fsS https://alcomatcher.com/health
