name: Deploy Web To DO

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on alcobot
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: alcomatcher.com
          username: root
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail
            if [ ! -d /opt/alcomatcher/.git ]; then
              rm -rf /opt/alcomatcher
              git clone https://github.com/kentbull/alcomatcher.git /opt/alcomatcher
            fi
            cd /opt/alcomatcher
            git fetch --all --prune
            git checkout master
            git pull --ff-only origin master
            [ -f .env ] || cp .env.example .env
            docker compose up -d --remove-orphans
            curl -fsS http://127.0.0.1:3000/health

      - name: Verify public health
        run: curl -fsS https://alcomatcher.com/health
